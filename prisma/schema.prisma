datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  USER
  RESPONSABLE
  DIRECTEUR
  DIRECTEUR_GENERAL
  MAGASINIER
  RH
  AUDIT
  IT_ADMIN
  DAF
  DOG
  DRH
  DCM
}

enum Access {
  APPROVE_EDB
  APPROVE_ODM
  CREATE_ODM
  ATTACH_DOCUMENTS
  CHOOSE_SUPPLIER
  IT_APPROVAL
  FINAL_APPROVAL
  RH_APPROVE
  RH_PROCESS
  CASHIER
  // Add other specific access types as needed
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum NotificationType {
  EDB_CREATED
  EDB_APPROVED_SUPERIOR
  EDB_APPROVED_DIRECTOR
  EDB_ESCALATED
  EDB_APPROVED_DG
  EDB_MAGASINIER_ATTACHED
  EDB_SUPPLIER_CHOSEN
  EDB_DELIVERED
  EDB_CONVERTED
  EDB_FINAL_APPROVAL
  EDB_UPDATED
  ODM_CREATED
  ODM_APPROVED_DIRECTOR
  ODM_APPROVED_RH
  ODM_RH_PROCESSING
  ODM_AWAITING_FINANCE_APPROVAL
  ODM_COMPLETED
  ODM_UPDATED
  ODM_REJECTED
  EDB_REJECTED
  BDC_CREATED
  BDC_APPROVED_RESPONSABLE
  BDC_APPROVED_DIRECTOR
  BDC_APPROVED_DAF
  BDC_PRINTED
  BDC_REJECTED
}

enum AttachmentType {
  INITIAL
  MAGASINIER
  RECEIPT
  OTHER
}



enum EDBStatus {
  DRAFT
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  ESCALATED
  APPROVED_DG
  AWAITING_MAGASINIER
  MAGASINIER_ATTACHED
  AWAITING_SUPPLIER_CHOICE
  SUPPLIER_CHOSEN
  AWAITING_IT_APPROVAL
  IT_APPROVED
  AWAITING_FINAL_APPROVAL
  FINAL_APPROVAL
  DELIVERED
  REJECTED
  COMPLETED
}

enum ODMStatus {
  DRAFT
  SUBMITTED
  AWAITING_DIRECTOR_APPROVAL
  AWAITING_RH_PROCESSING
  RH_PROCESSING
  AWAITING_FINANCE_APPROVAL
  COMPLETED
  REJECTED
}

enum BDCStatus {
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DAF
  PRINTED
  REJECTED
  UPDATED
}

enum CategoryType {
  DEFAULT
  CUSTOM
}

enum EDBEventType {
  DRAFT_CREATED
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DG
  REJECTED
  UPDATED
  FINAL_APPROVAL
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  ESCALATED
  MAGASINIER_ATTACHED
  SUPPLIER_CHOSEN
  DELIVERED
  IT_APPROVED
  COMPLETED
  STOCK_CREATED
  CONVERTED
}

enum ODMEventType {
  DRAFT
  SUBMITTED
  AWAITING_DIRECTOR_APPROVAL
  AWAITING_RH_PROCESSING
  RH_PROCESSING
  AWAITING_FINANCE_APPROVAL
  COMPLETED
  REJECTED
  UPDATED
}

enum BDCEventType {
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DAF
  REJECTED
  COMPLETED
  UPDATED
  PRINTED
}

enum ODMPersonCategory {
  DIRECTOR      // Directeur - 25k CFA/jour
  TEAM_MANAGER  // Chef d'équipe - 20k CFA/jour
  FIELD_AGENT   // Agent de terrain - 15k CFA/jour
  FREELANCER    // Freelance - 10k CFA/jour
}

enum EDBType {
  STANDARD    // Regular EDBs that need validation
  STOCK       // Items directly from stock (auto-completed)
}

enum StockEDBStatus {
  DRAFT       // Initial state when created
  SUBMITTED   // When user submits
  ORDERED     // When magasinier marks as ordered
  DELIVERED   // When magasinier marks as delivered
  PARTIALLY_DELIVERED // When magasinier marks as partially delivered
  CONVERTED   // When converted to standard EDB
}

model User {
  id                    Int             @id @default(autoincrement())
  email                 String          @unique
  name                  String
  role                  Role
  access                Access[]        // New field for flexible access control
  password              String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  employee              Employee?
  status                UserStatus      @default(ACTIVE)
  createdEdbs           EtatDeBesoin[]  @relation("UserCreator")
  approvedEdbs          EtatDeBesoin[]  @relation("Approver")
  createdOdms           OrdreDeMission[] @relation("UserCreator")
  approvedOdms          OrdreDeMission[] @relation("Approver")
  receivedNotifications NotificationRecipient[]
  itApprovedEdbs        EtatDeBesoin[]  @relation("ITApprover")
  finalApprovedEdbs     EtatDeBesoin[]  @relation("FinalApprover")
  uploadedAttachments   Attachment[]    @relation("Uploader")
  chosenSuppliers       FinalSupplier[] @relation("Chooser")
  edbAuditLogs          EtatDeBesoinAuditLog[]
  OrdreDeMission        OrdreDeMission[] @relation("RHProcessor")
  odmAuditLogs          OrdreDeMissionAuditLog[]
  orderedStockEdbs      StockEtatDeBesoin[] @relation("StockOrderer")
  deliveredStockEdbs    StockEtatDeBesoin[] @relation("StockDeliverer")
  convertedStockEdbs    StockEtatDeBesoin[] @relation("StockConverter")
  createdBdcs           BonDeCaisse[] @relation("BDCUserCreator")
  approvedBdcs          BonDeCaisse[] @relation("BDCApprover")
  approvedDAFBdcs       BonDeCaisse[] @relation("BDCApproverDAF")
  printedBdcs           BonDeCaisse[] @relation("BDCPrinter")
  bdcAuditLogs          BonDeCaisseAuditLog[]
}

model Employee {
  id                  Int                         @id @default(autoincrement())
  name                String
  email               String                      @unique
  matriculation       String                      @unique
  jobTitle            String                      @default("Employé")
  phoneNumber         String?
  user                User                        @relation(fields: [userId], references: [id])
  userId              Int                         @unique
  currentDepartmentId Int
  currentDepartment   Department                  @relation("CurrentEmployees", fields: [currentDepartmentId], references: [id])
  status              EmployeeStatus              @default(ACTIVE)
  departmentHistory   EmployeeDepartmentHistory[]
  createdEdbs         EtatDeBesoin[]              @relation("EmployeeCreator")
  createdOdms         OrdreDeMission[]            @relation("EmployeeCreator")
  stockEdbs           StockEtatDeBesoin[]         @relation("StockCreator")
  createdBdcs         BonDeCaisse[]               @relation("BDCCreator")
}

model Department {
  id               Int                         @id @default(autoincrement())
  name             String
  currentEmployees Employee[]                  @relation("CurrentEmployees")
  edbs             EtatDeBesoin[]
  odms             OrdreDeMission[]
  employeeHistory  EmployeeDepartmentHistory[]
  stockEdbs        StockEtatDeBesoin[]
  bdcs             BonDeCaisse[]
  
}

model EmployeeDepartmentHistory {
  id           Int        @id @default(autoincrement())
  employeeId   Int
  employee     Employee   @relation(fields: [employeeId], references: [id])
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  startDate    DateTime
  endDate      DateTime?
}



model EtatDeBesoin {
  id                    Int            @id @default(autoincrement())
  edbId                 String         @unique
  title                 String?
  description           Json
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  status                EDBStatus      @default(DRAFT)
  departmentId          Int
  department            Department     @relation(fields: [departmentId], references: [id])
  creatorId             Int
  creator               Employee       @relation("EmployeeCreator", fields: [creatorId], references: [id])
  userCreatorId         Int
  userCreator           User           @relation("UserCreator", fields: [userCreatorId], references: [id])
  approverId            Int?
  approver              User?          @relation("Approver", fields: [approverId], references: [id])
  categoryId            Int
  category              Category       @relation(fields: [categoryId], references: [id])
  orders                Order[]
  notifications         Notification[]
  isEscalated           Boolean        @default(false)
  references            String?
  attachments           Attachment[]
  finalSupplier         FinalSupplier?
  magasinierAttachedAt  DateTime?
  itApprovalRequired    Boolean        @default(false)
  itApprovedAt          DateTime?
  itApprovedBy          Int?
  itApprover            User?          @relation("ITApprover", fields: [itApprovedBy], references: [id])
  finalApprovedAt       DateTime?
  finalApprovedBy       Int?
  finalApprover         User?          @relation("FinalApprover", fields: [finalApprovedBy], references: [id])
  rejectionReason       String?
  convertedFromStock    StockEtatDeBesoin? @relation("ConvertedEDB")
  auditLogs     EtatDeBesoinAuditLog[]
}

model EtatDeBesoinAuditLog {
  id            Int           @id @default(autoincrement())
  etatDeBesoinId Int
  etatDeBesoin  EtatDeBesoin  @relation(fields: [etatDeBesoinId], references: [id])
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  eventType     EDBEventType
  eventAt       DateTime      @default(now())
  details       Json?         // For storing any additional event-specific details
}

model StockEtatDeBesoin {
  id                    Int             @id @default(autoincrement())
  edbId                 String          @unique
  description          Json            // Will now contain: { items: Array<{ name: string, quantity: number, comment: string }> }
  deliveryHistory     Json?           // Will contain: Array<{ items: Array<{ name: string, quantity: number }>, deliveredAt: string, deliveredBy: number }>
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  status               StockEDBStatus  @default(SUBMITTED)
  employeeId           Int?         
  employee             Employee?       @relation("StockCreator", fields: [employeeId], references: [id])
  externalEmployeeName  String?        
  departmentId         Int
  department           Department      @relation(fields: [departmentId], references: [id])
  categoryId           Int
  category             Category        @relation(fields: [categoryId], references: [id])
  convertedEdbId       Int?            @unique
  convertedEdb         EtatDeBesoin?   @relation("ConvertedEDB", fields: [convertedEdbId], references: [id])
  orderedAt            DateTime?      
  orderedById          Int?           
  orderedBy            User?           @relation("StockOrderer", fields: [orderedById], references: [id])
  deliveredAt          DateTime?      
  deliveredById        Int?           
  deliveredBy          User?           @relation("StockDeliverer", fields: [deliveredById], references: [id])
  convertedAt          DateTime?      
  convertedById        Int?           
  convertedBy          User?           @relation("StockConverter", fields: [convertedById], references: [id])
  isFullyDelivered     Boolean         @default(false)
}
model Attachment {
  id           Int      @id @default(autoincrement())
  edbId        Int
  edb          EtatDeBesoin @relation(fields: [edbId], references: [id])
  filePath     String
  fileName     String
  supplierName String
  totalAmount  Float
  uploadedAt   DateTime @default(now())
  uploadedBy   Int
  uploader     User     @relation("Uploader", fields: [uploadedBy], references: [id])
  type         AttachmentType
}

model FinalSupplier {
  id           Int      @id @default(autoincrement())
  edbId        Int      @unique
  edb          EtatDeBesoin @relation(fields: [edbId], references: [id])
  filePath     String
  supplierName String
  amount       Float
  chosenAt     DateTime @default(now())
  chosenBy     Int
  chooser      User     @relation("Chooser", fields: [chosenBy], references: [id])
}

model OrdreDeMission {
  id                Int            @id @default(autoincrement())
  odmId             String         @unique
  title             String
  missionType       String
  startDate         DateTime
  endDate           DateTime
  location          String
  description       Json
  hasAccompanying   Boolean        @default(false)
  accompanyingPersons Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  status            ODMStatus      @default(DRAFT)
  vehicule          String?
  departmentId      Int
  department        Department     @relation(fields: [departmentId], references: [id])
  creatorId         Int
  creator           Employee       @relation("EmployeeCreator", fields: [creatorId], references: [id])
  userCreatorId     Int
  userCreator       User           @relation("UserCreator", fields: [userCreatorId], references: [id])
  approverId        Int?
  approver          User?          @relation("Approver", fields: [approverId], references: [id])
  rhProcessorId     Int?
  rhProcessor       User?          @relation("RHProcessor", fields: [rhProcessorId], references: [id])
  notifications     Notification[]
  missionCostPerDay Float          @default(25000) // Fixed at 25,000 CFA per day
  expenseItems      Json?          // New JSON field to store expense items
  totalCost         Float?
  auditLogs         OrdreDeMissionAuditLog[]
  rejectionReason   String?
}

model OrdreDeMissionAuditLog {
  id                Int           @id @default(autoincrement())
  ordreDeMissionId  Int
  ordreDeMission    OrdreDeMission @relation(fields: [ordreDeMissionId], references: [id])
  userId            Int
  user              User          @relation(fields: [userId], references: [id])
  eventType         ODMEventType
  eventAt           DateTime      @default(now())
  details           Json?         // For storing any additional event-specific details
}

model BonDeCaisse {
  id              Int              @id @default(autoincrement())
  bdcId           String           @unique // For generating formatted IDs like BDC-2024-001
  title           String
  description     Json             // Will store array of {item: string, amount: number}
  employees       Json             // Will store array of {name: string, role: string}
  comment         String?
  totalAmount     Float
  status          BDCStatus        @default(SUBMITTED)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  departmentId    Int
  department      Department       @relation(fields: [departmentId], references: [id])
  creatorId       Int
  creator         Employee         @relation("BDCCreator", fields: [creatorId], references: [id])
  userCreatorId   Int
  userCreator     User            @relation("BDCUserCreator", fields: [userCreatorId], references: [id])
  approverId      Int?
  approver        User?           @relation("BDCApprover", fields: [approverId], references: [id])
  approverDAFId   Int?
  approverDAF     User?           @relation("BDCApproverDAF", fields: [approverDAFId], references: [id])
  printedById     Int?
  printedBy       User?           @relation("BDCPrinter", fields: [printedById], references: [id])
  printedAt       DateTime?
  rejectionReason String?
  notifications   Notification[]
  auditLogs       BonDeCaisseAuditLog[]
}

model BonDeCaisseAuditLog {
  id            Int           @id @default(autoincrement())
  bonDeCaisseId Int
  bonDeCaisse   BonDeCaisse  @relation(fields: [bonDeCaisseId], references: [id])
  userId        Int
  user          User         @relation(fields: [userId], references: [id])
  eventType     BDCEventType
  eventAt       DateTime     @default(now())
  details       Json?        // For storing any additional event-specific details
}


model Category {
  id   Int            @id @default(autoincrement())
  name String         @unique
  edbs                EtatDeBesoin[]
  type                CategoryType @default(CUSTOM)
  stockEdbs           StockEtatDeBesoin[]
}

model Order {
  id             Int          @id @default(autoincrement())
  amount         Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  etatDeBesoinId Int
  etatDeBesoin   EtatDeBesoin @relation(fields: [etatDeBesoinId], references: [id])
}

model Notification {
  id               Int              @id @default(autoincrement())
  message          String
  type             NotificationType
  createdAt        DateTime         @default(now())
  etatDeBesoinId   Int?
  etatDeBesoin     EtatDeBesoin?    @relation(fields: [etatDeBesoinId], references: [id])
  ordreDeMissionId Int?
  ordreDeMission   OrdreDeMission?  @relation(fields: [ordreDeMissionId], references: [id])
  recipients       NotificationRecipient[]
  bonDeCaisseId Int?
  bonDeCaisse   BonDeCaisse? @relation(fields: [bonDeCaisseId], references: [id])
}

model NotificationRecipient {
  id             Int          @id @default(autoincrement())
  notificationId Int
  notification   Notification @relation(fields: [notificationId], references: [id])
  userId         Int
  user           User         @relation(fields: [userId], references: [id])
  isRead         Boolean      @default(false)
  emailSent      Boolean      @default(false)

  @@unique([notificationId, userId])
}
