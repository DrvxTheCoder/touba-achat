datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  USER
  RESPONSABLE
  DIRECTEUR
  DIRECTEUR_GENERAL
  MAGASINIER
  RH
  AUDIT
  IT_ADMIN
  DAF
  DOG
  DRH
  DCM
}

enum Access {
  APPROVE_EDB
  APPROVE_ODM
  CREATE_ODM
  ATTACH_DOCUMENTS
  CHOOSE_SUPPLIER
  IT_APPROVAL
  FINAL_APPROVAL
  RH_APPROVE
  RH_PROCESS
  CASHIER
  APPROVE_BDC
  CREATE_PRODUCTION_INVENTORY
  VIEW_PRODUCTION_DASHBOARD
  VALIDATE_PRODUCTION_INVENTORY
  EXPORT_PRODUCTION_REPORTS
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum NotificationType {
  EDB_CREATED
  EDB_APPROVED_SUPERIOR
  EDB_APPROVED_DIRECTOR
  EDB_ESCALATED
  EDB_APPROVED_DG
  EDB_MAGASINIER_ATTACHED
  EDB_SUPPLIER_CHOSEN
  EDB_DELIVERED
  EDB_CONVERTED
  EDB_FINAL_APPROVAL
  EDB_UPDATED
  ODM_CREATED
  ODM_APPROVED_DIRECTOR
  ODM_APPROVED_RH
  ODM_RH_PROCESSING
  ODM_AWAITING_FINANCE_APPROVAL
  ODM_COMPLETED
  ODM_UPDATED
  ODM_REJECTED
  EDB_REJECTED
  BDC_CREATED
  BDC_APPROVED_RESPONSABLE
  BDC_APPROVED_DIRECTOR
  BDC_APPROVED_DAF
  BDC_PRINTED
  BDC_REJECTED
}

enum AttachmentType {
  INITIAL
  MAGASINIER
  RECEIPT
  OTHER
}



enum EDBStatus {
  DRAFT
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  ESCALATED
  APPROVED_DG
  AWAITING_MAGASINIER
  MAGASINIER_ATTACHED
  AWAITING_SUPPLIER_CHOICE
  SUPPLIER_CHOSEN
  AWAITING_IT_APPROVAL
  IT_APPROVED
  AWAITING_FINAL_APPROVAL
  FINAL_APPROVAL
  DELIVERED
  REJECTED
  COMPLETED
}

enum ODMStatus {
  DRAFT
  SUBMITTED
  AWAITING_DIRECTOR_APPROVAL
  AWAITING_RH_PROCESSING
  RH_PROCESSING
  AWAITING_FINANCE_APPROVAL
  COMPLETED
  REJECTED
}

enum BDCStatus {
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DAF
  PRINTED
  REJECTED
  UPDATED
}

enum CategoryType {
  DEFAULT
  CUSTOM
}

enum EDBEventType {
  DRAFT_CREATED
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DG
  REJECTED
  UPDATED
  FINAL_APPROVAL
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  ESCALATED
  MAGASINIER_ATTACHED
  SUPPLIER_CHOSEN
  DELIVERED
  IT_APPROVED
  COMPLETED
  STOCK_CREATED
  CONVERTED
}

enum ODMEventType {
  DRAFT
  SUBMITTED
  AWAITING_DIRECTOR_APPROVAL
  AWAITING_RH_PROCESSING
  RH_PROCESSING
  AWAITING_FINANCE_APPROVAL
  COMPLETED
  REJECTED
  UPDATED
}

enum BDCEventType {
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DAF
  REJECTED
  COMPLETED
  UPDATED
  PRINTED
}

enum ODMPersonCategory {
  DIRECTOR      // Directeur - 25k CFA/jour
  TEAM_MANAGER  // Chef d'équipe - 20k CFA/jour
  FIELD_AGENT   // Agent de terrain - 15k CFA/jour
  FREELANCER    // Freelance - 10k CFA/jour
}

enum EDBType {
  STANDARD    // Regular EDBs that need validation
  STOCK       // Items directly from stock (auto-completed)
}

enum StockEDBStatus {
  DRAFT       // Initial state when created
  SUBMITTED   // When user submits
  ORDERED     // When magasinier marks as ordered
  DELIVERED   // When magasinier marks as delivered
  PARTIALLY_DELIVERED // When magasinier marks as partially delivered
  CONVERTED   // When converted to standard EDB
}

enum ProductionStatus {
  EN_COURS              // Journée démarrée, saisie non complétée
  TERMINE               // Saisie complétée et validée
  ARCHIVE               // Archivé (> 2 ans)
}

enum ArretType {
  BASCULES              // Problèmes de bascules
  CHANGEMENT_FORMAT     // Changement de format de bouteilles
  SENSIBILISATION       // Session de sensibilisation
  VEHICULE_MANQUANT     // Véhicule manquant
  VEHICULE_EN_PANNE     // Véhicule en panne
  BOUTEILLES_MANQUANTES // Bouteilles manquantes
  INCIDENT_TECHNIQUE    // Incident technique
  PANNE                 // Panne équipement
  MAINTENANCE           // Maintenance préventive/curative
  AUTRE                 // Autre raison
}

enum BottleType {
  B2_7                  // 2.7kg
  B6                    // 6kg
  B9                    // 9kg
  B12_5                 // 12.5kg
  B12_5K                // 12.5kg Kheuweul (avec robinet)
  B38                   // 38kg
}

enum SphereType {
  SO2
  SO3
  D100
}

enum ReservoirType {
  SPHERE
  CIGARE
  AUTRE
}

enum CalculationMode {
  AUTOMATIC        // Calculs automatiques avec tous les champs de saisie
  MANUAL           // Saisie manuelle directe du poids liquide
  PERCENTAGE_BASED // Calcul basé sur pourcentage réservoir × capacité × densité ambiante
}

model User {
  id                    Int             @id @default(autoincrement())
  email                 String          @unique
  name                  String
  role                  Role
  access                Access[]        // New field for flexible access control
  password              String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  employee              Employee?
  status                UserStatus      @default(ACTIVE)
  createdEdbs           EtatDeBesoin[]  @relation("UserCreator")
  approvedEdbs          EtatDeBesoin[]  @relation("Approver")
  createdOdms           OrdreDeMission[] @relation("UserCreator")
  approvedOdms          OrdreDeMission[] @relation("Approver")
  receivedNotifications NotificationRecipient[]
  itApprovedEdbs        EtatDeBesoin[]  @relation("ITApprover")
  finalApprovedEdbs     EtatDeBesoin[]  @relation("FinalApprover")
  uploadedAttachments   Attachment[]    @relation("Uploader")
  chosenSuppliers       FinalSupplier[] @relation("Chooser")
  edbAuditLogs          EtatDeBesoinAuditLog[]
  OrdreDeMission        OrdreDeMission[] @relation("RHProcessor")
  odmAuditLogs          OrdreDeMissionAuditLog[]
  orderedStockEdbs      StockEtatDeBesoin[] @relation("StockOrderer")
  deliveredStockEdbs    StockEtatDeBesoin[] @relation("StockDeliverer")
  convertedStockEdbs    StockEtatDeBesoin[] @relation("StockConverter")
  createdBdcs           BonDeCaisse[] @relation("BDCUserCreator")
  approvedBdcs          BonDeCaisse[] @relation("BDCApprover")
  approvedDAFBdcs       BonDeCaisse[] @relation("BDCApproverDAF")
  rejectedBdcs          BonDeCaisse[] @relation("BDCRejector")
  printedBdcs           BonDeCaisse[] @relation("BDCPrinter")
  bdcAuditLogs          BonDeCaisseAuditLog[]
  ProductionStarter     ProductionInventory[] @relation("ProductionStarter")
  ProductionCompleter   ProductionInventory[] @relation("ProductionCompleter")
  ArretCreator          ProductionArret[] @relation("ArretCreator")
  ProductionCentersManaged ProductionCenterChef[] @relation("ProductionCenterChefs")
  inventoryAuditLogs    InventoryAuditLog[] @relation("InventoryEditor")
}

model Employee {
  id                  Int                         @id @default(autoincrement())
  name                String
  email               String                      @unique
  matriculation       String                      @unique
  jobTitle            String                      @default("Employé")
  phoneNumber         String?
  user                User                        @relation(fields: [userId], references: [id])
  userId              Int                         @unique
  currentDepartmentId Int
  currentDepartment   Department                  @relation("CurrentEmployees", fields: [currentDepartmentId], references: [id])
  status              EmployeeStatus              @default(ACTIVE)
  departmentHistory   EmployeeDepartmentHistory[]
  createdEdbs         EtatDeBesoin[]              @relation("EmployeeCreator")
  createdOdms         OrdreDeMission[]            @relation("EmployeeCreator")
  stockEdbs           StockEtatDeBesoin[]         @relation("StockCreator")
  createdBdcs         BonDeCaisse[]               @relation("BDCCreator")
}

model Department {
  id               Int                         @id @default(autoincrement())
  name             String
  currentEmployees Employee[]                  @relation("CurrentEmployees")
  edbs             EtatDeBesoin[]
  odms             OrdreDeMission[]
  employeeHistory  EmployeeDepartmentHistory[]
  stockEdbs        StockEtatDeBesoin[]
  bdcs             BonDeCaisse[]
  
}

model EmployeeDepartmentHistory {
  id           Int        @id @default(autoincrement())
  employeeId   Int
  employee     Employee   @relation(fields: [employeeId], references: [id])
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  startDate    DateTime
  endDate      DateTime?
}



model EtatDeBesoin {
  id                    Int            @id @default(autoincrement())
  edbId                 String         @unique
  title                 String?
  description           Json
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  status                EDBStatus      @default(DRAFT)
  departmentId          Int
  department            Department     @relation(fields: [departmentId], references: [id])
  creatorId             Int
  creator               Employee       @relation("EmployeeCreator", fields: [creatorId], references: [id])
  userCreatorId         Int
  userCreator           User           @relation("UserCreator", fields: [userCreatorId], references: [id])
  approverId            Int?
  approver              User?          @relation("Approver", fields: [approverId], references: [id])
  categoryId            Int
  category              Category       @relation(fields: [categoryId], references: [id])
  orders                Order[]
  notifications         Notification[]
  isEscalated           Boolean        @default(false)
  references            String?
  attachments           Attachment[]
  finalSupplier         FinalSupplier?
  magasinierAttachedAt  DateTime?
  itApprovalRequired    Boolean        @default(false)
  itApprovedAt          DateTime?
  itApprovedBy          Int?
  itApprover            User?          @relation("ITApprover", fields: [itApprovedBy], references: [id])
  finalApprovedAt       DateTime?
  finalApprovedBy       Int?
  finalApprover         User?          @relation("FinalApprover", fields: [finalApprovedBy], references: [id])
  rejectionReason       String?
  convertedFromStock    StockEtatDeBesoin? @relation("ConvertedEDB")
  auditLogs     EtatDeBesoinAuditLog[]
}

model EtatDeBesoinAuditLog {
  id            Int           @id @default(autoincrement())
  etatDeBesoinId Int
  etatDeBesoin  EtatDeBesoin  @relation(fields: [etatDeBesoinId], references: [id])
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  eventType     EDBEventType
  eventAt       DateTime      @default(now())
  details       Json?         // For storing any additional event-specific details
}

model StockEtatDeBesoin {
  id                    Int             @id @default(autoincrement())
  edbId                 String          @unique
  description          Json            // Will now contain: { items: Array<{ name: string, quantity: number, comment: string }> }
  deliveryHistory     Json?           // Will contain: Array<{ items: Array<{ name: string, quantity: number }>, deliveredAt: string, deliveredBy: number }>
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  status               StockEDBStatus  @default(SUBMITTED)
  employeeId           Int?         
  employee             Employee?       @relation("StockCreator", fields: [employeeId], references: [id])
  externalEmployeeName  String?        
  departmentId         Int
  department           Department      @relation(fields: [departmentId], references: [id])
  categoryId           Int
  category             Category        @relation(fields: [categoryId], references: [id])
  convertedEdbId       Int?            @unique
  convertedEdb         EtatDeBesoin?   @relation("ConvertedEDB", fields: [convertedEdbId], references: [id])
  orderedAt            DateTime?      
  orderedById          Int?           
  orderedBy            User?           @relation("StockOrderer", fields: [orderedById], references: [id])
  deliveredAt          DateTime?      
  deliveredById        Int?           
  deliveredBy          User?           @relation("StockDeliverer", fields: [deliveredById], references: [id])
  convertedAt          DateTime?      
  convertedById        Int?           
  convertedBy          User?           @relation("StockConverter", fields: [convertedById], references: [id])
  isFullyDelivered     Boolean         @default(false)
}
model Attachment {
  id           Int      @id @default(autoincrement())
  edbId        Int
  edb          EtatDeBesoin @relation(fields: [edbId], references: [id])
  filePath     String
  fileName     String
  supplierName String
  totalAmount  Float
  uploadedAt   DateTime @default(now())
  uploadedBy   Int
  uploader     User     @relation("Uploader", fields: [uploadedBy], references: [id])
  type         AttachmentType
}

model FinalSupplier {
  id           Int      @id @default(autoincrement())
  edbId        Int      @unique
  edb          EtatDeBesoin @relation(fields: [edbId], references: [id])
  filePath     String
  supplierName String
  amount       Float
  chosenAt     DateTime @default(now())
  chosenBy     Int
  chooser      User     @relation("Chooser", fields: [chosenBy], references: [id])
}

model OrdreDeMission {
  id                Int            @id @default(autoincrement())
  odmId             String         @unique
  title             String
  missionType       String
  startDate         DateTime
  endDate           DateTime
  location          String
  description       Json
  hasAccompanying   Boolean        @default(false)
  accompanyingPersons Json?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  status            ODMStatus      @default(DRAFT)
  vehicule          String?
  departmentId      Int
  department        Department     @relation(fields: [departmentId], references: [id])
  creatorId         Int
  creator           Employee       @relation("EmployeeCreator", fields: [creatorId], references: [id])
  userCreatorId     Int
  userCreator       User           @relation("UserCreator", fields: [userCreatorId], references: [id])
  approverId        Int?
  approver          User?          @relation("Approver", fields: [approverId], references: [id])
  rhProcessorId     Int?
  rhProcessor       User?          @relation("RHProcessor", fields: [rhProcessorId], references: [id])
  notifications     Notification[]
  missionCostPerDay Float          @default(25000) // Fixed at 25,000 CFA per day
  expenseItems      Json?          // New JSON field to store expense items
  totalCost         Float?
  auditLogs         OrdreDeMissionAuditLog[]
  rejectionReason   String?
}

model OrdreDeMissionAuditLog {
  id                Int           @id @default(autoincrement())
  ordreDeMissionId  Int
  ordreDeMission    OrdreDeMission @relation(fields: [ordreDeMissionId], references: [id])
  userId            Int
  user              User          @relation(fields: [userId], references: [id])
  eventType         ODMEventType
  eventAt           DateTime      @default(now())
  details           Json?         // For storing any additional event-specific details
}

model BonDeCaisse {
  id              Int              @id @default(autoincrement())
  bdcId           String           @unique // For generating formatted IDs like BDC-2024-001
  title           String
  description     Json             // Will store array of {item: string, amount: number}
  employees       Json             // Will store array of {name: string, role: string}
  comment         String?
  totalAmount     Float
  status          BDCStatus        @default(SUBMITTED)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  departmentId    Int
  department      Department       @relation(fields: [departmentId], references: [id])
  creatorId       Int
  creator         Employee         @relation("BDCCreator", fields: [creatorId], references: [id])
  userCreatorId   Int
  userCreator     User            @relation("BDCUserCreator", fields: [userCreatorId], references: [id])
  approverId      Int?
  approver        User?           @relation("BDCApprover", fields: [approverId], references: [id])
  rejectorId      Int?
  rejector        User?           @relation("BDCRejector", fields: [rejectorId], references: [id])
  approverDAFId   Int?
  approverDAF     User?           @relation("BDCApproverDAF", fields: [approverDAFId], references: [id])
  printedById     Int?
  printedBy       User?           @relation("BDCPrinter", fields: [printedById], references: [id])
  printedAt       DateTime?
  rejectionReason String?
  notifications   Notification[]
  auditLogs       BonDeCaisseAuditLog[]
}

model BonDeCaisseAuditLog {
  id            Int           @id @default(autoincrement())
  bonDeCaisseId Int
  bonDeCaisse   BonDeCaisse  @relation(fields: [bonDeCaisseId], references: [id])
  userId        Int
  user          User         @relation(fields: [userId], references: [id])
  eventType     BDCEventType
  eventAt       DateTime     @default(now())
  details       Json?        // For storing any additional event-specific details
}

model ProductionInventory {
  id                    Int                  @id @default(autoincrement())
  date                  DateTime
  status                ProductionStatus     @default(EN_COURS)

  // Centre de production
  productionCenterId    Int?
  productionCenter      ProductionCenter?    @relation(fields: [productionCenterId], references: [id])

  // Timeline
  startedAt             DateTime             @default(now())
  startedById           Int
  startedBy             User                 @relation("ProductionStarter", fields: [startedById], references: [id])

  completedAt           DateTime?
  completedById         Int?
  completedBy           User?                @relation("ProductionCompleter", fields: [completedById], references: [id])

  // Temps de production
  heureDebut            String?              // Heure de début (format HH:MM)
  heureFin              String?              // Heure de fin (format HH:MM)
  tempsTotal            Int                  // En minutes, calculé à partir de heureDebut et heureFin
  tempsArret            Int                  @default(0) // En minutes
  tempsUtile            Int                  // Calculé: tempsTotal - tempsArret
  rendement             Float?               // (tempsUtile / tempsTotal) * 100

  arrets                ProductionArret[]

  // Stocks
  stockInitialPhysique  Float                // Auto depuis veille

  // LEGACY - Keep for backward compatibility
  butanier              Float?
  recuperation          Float                @default(0)
  approSAR              Float                @default(0)
  ngabou                Float                @default(0)
  exports               Float                @default(0)
  divers                Float                @default(0)

  // NEW - Dynamic field values
  approValues           ApproValue[]
  sortieValues          SortieValue[]
  useDynamicFields      Boolean              @default(false)

  // Calculés
  cumulSortie           Float                @default(0)
  stockFinalTheorique   Float?
  stockFinalPhysique    Float?
  ecart                 Float?
  ecartPourcentage      Float?

  // Production
  bottles               BottleProduction[]
  totalBottlesProduced  Int                  @default(0)

  // Réservoirs
  reservoirs            Reservoir[]
  densiteAmbiante       Float?               // Densité ambiante partagée (mode PERCENTAGE_BASED)

  // Audit
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  observations          String?

  // Audit logs for edit tracking
  auditLogs             InventoryAuditLog[]

  @@unique([date, productionCenterId])
}

model ProductionArret {
  id                    Int                  @id @default(autoincrement())
  inventoryId           Int
  inventory             ProductionInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  type                  ArretType
  duree                 Int                  // En minutes - saisie manuelle
  remarque              String?

  createdAt             DateTime             @default(now())
  createdById           Int
  createdBy             User                 @relation("ArretCreator", fields: [createdById], references: [id])
}

model BottleProduction {
  id                    Int                  @id @default(autoincrement())
  inventoryId           Int
  inventory             ProductionInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  type                  BottleType
  quantity              Int
  tonnage               Float                // Calculé auto
  
  @@unique([inventoryId, type])
}

model Reservoir {
  id                    Int                  @id @default(autoincrement())
  inventoryId           Int
  inventory             ProductionInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  name                  String               // Nom du réservoir (D100, SO2, SO3, etc.)
  reservoirConfigId     Int?
  reservoirConfig       ReservoirConfig?     @relation(fields: [reservoirConfigId], references: [id])

  // 6 champs de saisie manuelle
  hauteur               Float                @default(0)     // en mm
  temperature           Float                @default(20)    // en °C (15.1 - 35.3) - température liquide
  temperatureVapeur     Float                @default(20)    // en °C (15.1 - 35.3) - température vapeur
  volumeLiquide         Float                @default(0)     // en m³
  pressionInterne       Float                @default(0)     // en bar
  densiteA15C           Float                @default(0) // densité à 15°C (typiquement 0.508)
  tankPercentage        Float                @default(0) // Pourcentage réservoir (mode PERCENTAGE_BASED)

  // 6 champs calculés automatiquement
  facteurCorrectionLiquide Float?
  facteurCorrectionVapeur  Float?
  densiteAmbiante          Float?
  poidsLiquide             Float?            // en tonnes
  poidsGaz                 Float?            // en tonnes
  poidsTotal               Float?            // en tonnes

  @@unique([inventoryId, name])
}

model ProductionCenter {
  id                    Int                  @id @default(autoincrement())
  name                  String               @unique
  address               String

  // Many-to-many relationship with production supervisors
  chefProductions       ProductionCenterChef[]

  // Production capacity configuration
  numberOfLines         Int                  @default(2)
  capacityPerLine       Float                @default(12.0)  // T/h per line
  totalHourlyCapacity   Float                @default(24.0)  // T/h total

  // Field configurations
  approFieldConfigs     ApproFieldConfig[]
  sortieFieldConfigs    SortieFieldConfig[]

  reservoirs            ReservoirConfig[]
  inventories           ProductionInventory[]

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
}

// Junction table for many-to-many relationship between ProductionCenter and User (chefs)
model ProductionCenterChef {
  id                    Int                  @id @default(autoincrement())
  productionCenterId    Int
  productionCenter      ProductionCenter     @relation(fields: [productionCenterId], references: [id], onDelete: Cascade)
  userId                Int
  user                  User                 @relation("ProductionCenterChefs", fields: [userId], references: [id], onDelete: Cascade)

  createdAt             DateTime             @default(now())

  @@unique([productionCenterId, userId])
}

model ReservoirConfig {
  id                    Int                  @id @default(autoincrement())
  name                  String               // D100, SO2, SO3, etc.
  type                  ReservoirType        // SPHERE, CIGARE, AUTRE
  capacity              Float                // Capacité en m³
  capacityTonnes        Float?               // Capacité en tonnes (optional in DB, required in API/UI)
  calculationMode       CalculationMode      @default(AUTOMATIC) // Mode de calcul

  productionCenterId    Int
  productionCenter      ProductionCenter     @relation(fields: [productionCenterId], references: [id], onDelete: Cascade)

  reservoirs            Reservoir[]

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@unique([name, productionCenterId])
}

model BottleTypeConfig {
  id                    Int                  @id @default(autoincrement())
  type                  BottleType           @unique
  weight                Float                // Poids en kg
  name                  String               // Nom d'affichage (ex: "2.7kg", "6kg", etc.)

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
}

model CorrectionFactorTable {
  id                    Int      @id @default(autoincrement())
  temperature           Float    @unique      // de 15.1 à 35.3 par pas de 0.2
  facteurLiquide        Float
  facteurVapeur         Float
}


model Category {
  id   Int            @id @default(autoincrement())
  name String         @unique
  edbs                EtatDeBesoin[]
  type                CategoryType @default(CUSTOM)
  stockEdbs           StockEtatDeBesoin[]
}

model Order {
  id             Int          @id @default(autoincrement())
  amount         Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  etatDeBesoinId Int
  etatDeBesoin   EtatDeBesoin @relation(fields: [etatDeBesoinId], references: [id])
}

model Notification {
  id               Int              @id @default(autoincrement())
  message          String
  type             NotificationType
  createdAt        DateTime         @default(now())
  etatDeBesoinId   Int?
  etatDeBesoin     EtatDeBesoin?    @relation(fields: [etatDeBesoinId], references: [id])
  ordreDeMissionId Int?
  ordreDeMission   OrdreDeMission?  @relation(fields: [ordreDeMissionId], references: [id])
  recipients       NotificationRecipient[]
  bonDeCaisseId Int?
  bonDeCaisse   BonDeCaisse? @relation(fields: [bonDeCaisseId], references: [id])
}

model NotificationRecipient {
  id             Int          @id @default(autoincrement())
  notificationId Int
  notification   Notification @relation(fields: [notificationId], references: [id])
  userId         Int
  user           User         @relation(fields: [userId], references: [id])
  isRead         Boolean      @default(false)
  emailSent      Boolean      @default(false)

  @@unique([notificationId, userId])
}

// ==================================
// Dynamic Production Fields
// ==================================

model ApproFieldConfig {
  id                    Int                  @id @default(autoincrement())
  productionCenterId    Int
  productionCenter      ProductionCenter     @relation(fields: [productionCenterId], references: [id], onDelete: Cascade)

  name                  String               // Internal key: "butanier", "recuperation", "approSAR", etc.
  label                 String               // Display name: "Butanier", "Récupération", "Appro SAR", etc.
  order                 Int                  @default(0)
  isActive              Boolean              @default(true)
  isRequired            Boolean              @default(false)

  values                ApproValue[]

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@unique([productionCenterId, name])
  @@index([productionCenterId, isActive])
}

model SortieFieldConfig {
  id                    Int                  @id @default(autoincrement())
  productionCenterId    Int
  productionCenter      ProductionCenter     @relation(fields: [productionCenterId], references: [id], onDelete: Cascade)

  name                  String               // Internal key: "ngabou", "vrac_local", "exports", "divers", etc.
  label                 String               // Display name: "Ngabou", "Vrac Local", "Exports", "Divers", etc.
  order                 Int                  @default(0)
  isActive              Boolean              @default(true)
  isRequired            Boolean              @default(false)

  values                SortieValue[]

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@unique([productionCenterId, name])
  @@index([productionCenterId, isActive])
}

model ApproValue {
  id                    Int                  @id @default(autoincrement())
  inventoryId           Int
  inventory             ProductionInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  fieldConfigId         Int
  fieldConfig           ApproFieldConfig     @relation(fields: [fieldConfigId], references: [id], onDelete: Restrict)

  value                 Float                @default(0)

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@unique([inventoryId, fieldConfigId])
  @@index([inventoryId])
}

model SortieValue {
  id                    Int                  @id @default(autoincrement())
  inventoryId           Int
  inventory             ProductionInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  fieldConfigId         Int
  fieldConfig           SortieFieldConfig    @relation(fields: [fieldConfigId], references: [id], onDelete: Restrict)

  value                 Float                @default(0)

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@unique([inventoryId, fieldConfigId])
  @@index([inventoryId])
}

// Audit log for production inventory edits
model InventoryAuditLog {
  id                    Int                  @id @default(autoincrement())
  inventoryId           Int
  inventory             ProductionInventory  @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  editedById            Int
  editedBy              User                 @relation("InventoryEditor", fields: [editedById], references: [id])

  editedAt              DateTime             @default(now())

  // JSON storing array of changes: [{ field, oldValue, newValue }, ...]
  changes               Json

  // Optional summary of changes
  summary               String?

  @@index([inventoryId])
  @@index([editedById])
  @@index([editedAt])
}
