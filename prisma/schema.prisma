datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Role {
  ADMIN
  USER
  RESPONSABLE
  DIRECTEUR
  DIRECTEUR_GENERAL
  MAGASINIER
  RH
  AUDIT
  IT_ADMIN
}

enum Access {
  APPROVE_EDB
  ATTACH_DOCUMENTS
  CHOOSE_SUPPLIER
  IT_APPROVAL
  FINAL_APPROVAL
  // Add other specific access types as needed
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum NotificationType {
  EDB_CREATED
  EDB_APPROVED_SUPERIOR
  EDB_APPROVED_DIRECTOR
  EDB_ESCALATED
  EDB_APPROVED_DG
  ODM_CREATED
  ODM_APPROVED_DIRECTOR
  ODM_APPROVED_RH
  EDB_REJECTED
}

enum AttachmentType {
  INITIAL
  MAGASINIER
  OTHER
}



enum EDBStatus {
  DRAFT
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  AWAITING_MAGASINIER
  MAGASINIER_ATTACHED
  AWAITING_SUPPLIER_CHOICE
  SUPPLIER_CHOSEN
  AWAITING_IT_APPROVAL
  IT_APPROVED
  AWAITING_FINAL_APPROVAL
  APPROVED_DG
  REJECTED
  COMPLETED
}

enum ODMStatus {
  DRAFT
  SUBMITTED
  APPROVED_DIRECTEUR
  APPROVED_RH
  REJECTED
  COMPLETED
}

enum CategoryType {
  DEFAULT
  CUSTOM
}

enum EDBEventType {
  CREATED
  SUBMITTED
  APPROVED_RESPONSABLE
  APPROVED_DIRECTEUR
  APPROVED_DG
  REJECTED
  UPDATED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  ESCALATED
}


model User {
  id                    Int             @id @default(autoincrement())
  email                 String          @unique
  name                  String
  role                  Role
  access                Access[]        // New field for flexible access control
  password              String
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  employee              Employee?
  status                UserStatus      @default(ACTIVE)
  createdEdbs           EtatDeBesoin[]  @relation("UserCreator")
  approvedEdbs          EtatDeBesoin[]  @relation("Approver")
  createdOdms           OrdreDeMission[] @relation("UserCreator")
  approvedOdms          OrdreDeMission[] @relation("Approver")
  sentNotifications     Notification[]  @relation("Sender")
  receivedNotifications Notification[]  @relation("Receiver")
  itApprovedEdbs        EtatDeBesoin[]  @relation("ITApprover")
  finalApprovedEdbs     EtatDeBesoin[]  @relation("FinalApprover")
  uploadedAttachments   Attachment[]    @relation("Uploader")
  chosenSuppliers       FinalSupplier[] @relation("Chooser")
  edbAuditLogs  EtatDeBesoinAuditLog[]
}

model Employee {
  id                  Int                         @id @default(autoincrement())
  name                String
  email               String                      @unique
  matriculation       String                      @unique
  phoneNumber         String?
  user                User                        @relation(fields: [userId], references: [id])
  userId              Int                         @unique
  currentDepartmentId Int
  currentDepartment   Department                  @relation("CurrentEmployees", fields: [currentDepartmentId], references: [id])
  status              EmployeeStatus              @default(ACTIVE)
  departmentHistory   EmployeeDepartmentHistory[]
  createdEdbs         EtatDeBesoin[]              @relation("EmployeeCreator")
  createdOdms         OrdreDeMission[]            @relation("EmployeeCreator")
}

model Department {
  id               Int                         @id @default(autoincrement())
  name             String
  currentEmployees Employee[]                  @relation("CurrentEmployees")
  edbs             EtatDeBesoin[]
  odms             OrdreDeMission[]
  employeeHistory  EmployeeDepartmentHistory[]
}

model EmployeeDepartmentHistory {
  id           Int        @id @default(autoincrement())
  employeeId   Int
  employee     Employee   @relation(fields: [employeeId], references: [id])
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  startDate    DateTime
  endDate      DateTime?
}



model EtatDeBesoin {
  id                    Int            @id @default(autoincrement())
  edbId                 String         @unique
  title                 String
  description           String[]
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  status                EDBStatus      @default(DRAFT)
  departmentId          Int
  department            Department     @relation(fields: [departmentId], references: [id])
  creatorId             Int
  creator               Employee       @relation("EmployeeCreator", fields: [creatorId], references: [id])
  userCreatorId         Int
  userCreator           User           @relation("UserCreator", fields: [userCreatorId], references: [id])
  approverId            Int?
  approver              User?          @relation("Approver", fields: [approverId], references: [id])
  categoryId            Int
  category              Category       @relation(fields: [categoryId], references: [id])
  orders                Order[]
  notifications         Notification[]
  isEscalated           Boolean        @default(false)
  references            String?
  attachments           Attachment[]
  finalSupplier         FinalSupplier?
  magasinierAttachedAt  DateTime?
  itApprovalRequired    Boolean        @default(false)
  itApprovedAt          DateTime?
  itApprovedBy          Int?
  itApprover            User?          @relation("ITApprover", fields: [itApprovedBy], references: [id])
  finalApprovedAt       DateTime?
  finalApprovedBy       Int?
  finalApprover         User?          @relation("FinalApprover", fields: [finalApprovedBy], references: [id])
  rejectionReason       String?
  auditLogs     EtatDeBesoinAuditLog[]
}

model EtatDeBesoinAuditLog {
  id            Int           @id @default(autoincrement())
  etatDeBesoinId Int
  etatDeBesoin  EtatDeBesoin  @relation(fields: [etatDeBesoinId], references: [id])
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  eventType     EDBEventType
  eventAt       DateTime      @default(now())
  details       Json?         // For storing any additional event-specific details
}

model Attachment {
  id           Int      @id @default(autoincrement())
  edbId        Int
  edb          EtatDeBesoin @relation(fields: [edbId], references: [id])
  filePath     String
  fileName     String
  supplierName String
  totalAmount  Float
  uploadedAt   DateTime @default(now())
  uploadedBy   Int
  uploader     User     @relation("Uploader", fields: [uploadedBy], references: [id])
  type         AttachmentType
}

model FinalSupplier {
  id           Int      @id @default(autoincrement())
  edbId        Int      @unique
  edb          EtatDeBesoin @relation(fields: [edbId], references: [id])
  filePath     String
  supplierName String
  amount       Float
  chosenAt     DateTime @default(now())
  chosenBy     Int
  chooser      User     @relation("Chooser", fields: [chosenBy], references: [id])
}

model OrdreDeMission {
  id            Int            @id @default(autoincrement())
  title         String
  description   String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  status        ODMStatus      @default(DRAFT)
  departmentId  Int
  department    Department     @relation(fields: [departmentId], references: [id])
  creatorId     Int
  creator       Employee       @relation("EmployeeCreator", fields: [creatorId], references: [id])
  userCreatorId Int
  userCreator   User           @relation("UserCreator", fields: [userCreatorId], references: [id])
  approverId    Int?
  approver      User?          @relation("Approver", fields: [approverId], references: [id])
  notifications Notification[]
}

model Category {
  id   Int            @id @default(autoincrement())
  name String         @unique
  edbs EtatDeBesoin[]
  type CategoryType @default(CUSTOM)
}

model Order {
  id             Int          @id @default(autoincrement())
  amount         Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  etatDeBesoinId Int
  etatDeBesoin   EtatDeBesoin @relation(fields: [etatDeBesoinId], references: [id])
}

model Notification {
  id               Int              @id @default(autoincrement())
  message          String
  type             NotificationType
  senderId         Int
  sender           User             @relation("Sender", fields: [senderId], references: [id])
  receiverId       Int
  receiver         User             @relation("Receiver", fields: [receiverId], references: [id])
  etatDeBesoinId   Int?
  etatDeBesoin     EtatDeBesoin?    @relation(fields: [etatDeBesoinId], references: [id])
  ordreDeMissionId Int?
  ordreDeMission   OrdreDeMission?  @relation(fields: [ordreDeMissionId], references: [id])
  createdAt        DateTime         @default(now())
  isRead           Boolean          @default(false)
  emailSent        Boolean          @default(false)
}
